---
- name: Create data dir
  file:
    state: directory
    path: "{{ service_user_data.home }}/app_data/{{ container_name }}/{{ item }}"
    owner: "{{ service_user_data.name }}"
    group: "{{ service_user_data.name }}"
    mode: 0700
  with_items:
  -
  - config
  - data

- name: Create {{ container_name }} container
  become: yes
  docker_container:
    name: "{{ container_name }}"
    network_mode: host
    state: present
    pull: yes
    image: simbelmas/filezilla
    ipc_mode: private
    shm_size: 2G
    groups: "{{ service_user_data.group }}"
    user: "{{ service_user_data.uid }}"
    env:
      DISPLAY: "unix{{ unix_display.stdout }}"
      UID: "{{ service_user_data.uid }}"
      GID: "{{ service_user_data.group }}"
    volumes:
    - "{{ service_user_data.home }}/.config/gtk-3.0/:/home/svc/.config/gtk-3.0:ro"
    - /etc/localtime:/etc/localtime:ro
    - /tmp/.X11-unix:/tmp/.X11-unix
    - "/run/user/{{ service_user_data.uid }}/bus:/run/user/{{ service_user_data.uid }}/bus"
    - "/run/user/{{ service_user_data.uid }}/dconf:/run/user/{{ service_user_data.uid }}/dconf"
    - /var/run/dbus:/var/run/dbus
    - /etc/machine-id:/etc/machine-id:ro
    - "{{ service_user_data.home }}/app_data/{{ container_name }}/data:/home/svc/data"
    - "{{ service_user_data.home }}/app_data/{{ container_name }}/config:/home/svc/.filezilla"

- name: Create launcher in path
  copy:
    dest: "{{ service_user_data.home }}/bin/{{ container_name }}"
    owner: "{{ service_user_data.name }}"
    mode: 0700
    content: |
      #!/bin/bash -ex
      docker start {{ container_name }} {{ extra_args | default('') }}
