---
- name: Create data dir
  file:
    state: directory
    path: "{{ service_user_data.home }}/app_data/{{ container_name }}"
    owner: "{{ service_user_data.name }}"
    group: "{{ service_user_data.group }}"

- name: Pull image
  podman_image:
    name: simbelmas/firefox
    state: present

- name: Create launcher in path
  copy:
    owner: "{{ service_user_data.name }}"
    group: "{{ service_user_data.group }}"
    dest: "{{ service_user_data.home }}/bin/{{ container_name }}"
    mode: 0700
    content: |
      #!/bin/bash -e

      #Start container
      if [ -z "$(podman ps | grep {{ container_name }} )" ] ; then
        (
          set -x
          podman container run \
            --privileged \
            --shm-size 2G \
            --rm \
            --dns 127.0.0.1,9.9.9.9 \
            --env "DISPLAY=unix{{ unix_display.stdout }}" \
            {% if firefox_storage | default(true) %}
             --volume "{{ service_user_data.home }}/app_data/{{ container_name }}:/root/.mozilla" \
            {% endif -%}
            --volume "{{ service_user_data.home }}/.config/gtk-3.0/:/root/.config/gtk-3.0:ro" \
            --volume "{{ download_dir | default(service_user_data.home + '/Téléchargements') }}:/root/Downloads" \
            --volume "{{ service_user_data.home }}/.pulse:/root/.pulse" \
            --volume "/run/user/{{ service_user_data.uid }}/pulse:/run/user/0/pulse" \
            --volume /etc/localtime:/etc/localtime:ro \
            --volume /tmp/.X11-unix:/tmp/.X11-unix \
            --name {{ container_name }} \
            localhost/simbelmas/firefox --no-remote --new-instance ${@}
        )
      fi
