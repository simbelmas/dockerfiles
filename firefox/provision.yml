---
- name: Create data dir
  file:
    state: directory
    path: "{{ service_user_data.home }}/app_data/{{ container_name }}"
    owner: "{{ service_user_data.name }}"
    group: "{{ service_user_data.group }}"
    mode: 0700

- name: Create {{ container_name }} container
  docker_container:
    name: "{{ service_user_data.name }}_{{ container_name }}"
    network_mode: host
    state: present
    #pull: yes
    image: simbelmas/firefox
    ipc_mode: private
    shm_size: 2G
    env:
      DISPLAY: "unix{{ unix_display.stdout }}"
      UID: "{{ service_user_data.uid }}"
      GID: "{{ service_user_data.group }}"
    volumes:
    - "{{ service_user_data.home }}/app_data/{{ container_name }}:/home/svc/.mozilla"
    - "{{ service_user_data.home }}/.pulse:/home/svc/.pulse"
    - "/run/user/{{ service_user_data.uid }}/pulse:/run/user/{{ service_user_data.uid }}/pulse"
    - "{{ service_user_data.home }}/.config/gtk-3.0/:/home/svc/.config/gtk-3.0:ro"
    - "{{ download_dir | default(service_user_data.home + '/Téléchargements') }}:/home/svc/Downloads"
    - "/tmp/{{ service_user_data.name }}_{{ container_name }}:/home/svc/host_pages"
    - /etc/localtime:/etc/localtime:ro
    - /tmp/.X11-unix:/tmp/.X11-unix
    - /dev/snd:/dev/snd

- name: Create launcher in path
  copy:
    owner: "{{ service_user_data.name }}"
    group: "{{ service_user_data.group }}"
    dest: "{{ service_user_data.home }}/bin/{{ container_name }}"
    mode: 0700
    content: |
      #!/bin/bash -e

      #Mount local dir
      if [ "$#" -gt 0 -a -n "$(echo ${!#} | grep -iE '.*html$')" -a -z "$(echo ${!#} | grep -iE 'http[s]?://')" ] ; then
        mountpoin_name=$(echo ${!#} | cut -f 1 -d'/')
        data_dir=$(readlink -m "${mountpoin_name}")
        dest_dir=/tmp/{{ service_user_data.name }}_{{ container_name }}/$(basename "${data_dir}")
        if [ ! -e "${dest_dir}" ] ; then
          mkdir "${dest_dir}"
        fi
        if [ -z "$(mount | grep "${dest_dir}")" ] ; then
          (
            set -x
            sudo mount -o bind "${data_dir}" "${dest_dir}"
          )
        fi
      fi

      #Start container
      if [ -z "$(docker ps -f name={{ container_name }} -q)" ] ; then
        (
          set -x
          docker start {{ service_user_data.name }}_{{ container_name }}
          sleep 5
        )
      fi

      #Load local page
      if [ -n "$(echo $@ | tr -d ' ')" ] ; then
        args=$(echo $@ | sed "s#${!#}#/home/svc/host_pages/${!#}#")
        (
          set -x
          docker exec {{ service_user_data.name }}_{{ container_name }} su svc -c "firefox $args"
        )
      fi

