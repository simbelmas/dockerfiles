---
- name: Create data dir
  file:
    state: directory
    path: "{{ service_user_data.home }}/app_data/{{ container_name }}"
    owner: "{{ service_user_data.name }}"
    group: "{{ service_user_data.name }}"
    mode: 0700

- name: Create {{ container_name }} container
  become: yes
  docker_container:
    name: "{{ container_name }}"
    network_mode: host
    state: present
    pull: yes
    image: simbelmas/firefox
    ipc_mode: private
    shm_size: 2G
    groups: "{{ service_user_data.group }}"
    user: "{{ service_user_data.uid }}"
    env:
      DISPLAY: "unix{{ unix_display.stdout }}"
      UID: "{{ service_user_data.uid }}"
      GID: "{{ service_user_data.group }}"
    volumes:
    - "{{ service_user_data.home }}/app_data/{{ container_name }}:/home/svc/.mozilla"
    - "{{ service_user_data.home }}/.pulse:/home/svc/.pulse"
    - "/run/user/{{ service_user_data.uid }}/pulse:/run/user/{{ service_user_data.uid }}/pulse"
    - "{{ service_user_data.home }}/.config/gtk-3.0/:/home/svc/.config/gtk-3.0:ro"
    - "{{ download_dir | default(service_user_data.home + '/Téléchargements') }}:/home/svc/Downloads"
    - /etc/localtime:/etc/localtime:ro
    - /tmp/.X11-unix:/tmp/.X11-unix
    - /dev/snd:/dev/snd


- name: Create launcher in path
  copy:
    dest: "{{ service_user_data.home }}/bin/{{ container_name }}"
    owner: "{{ service_user_data.name }}"
    mode: 0700
    content: |
      #!/bin/bash -ex
      docker start {{ container_name }} {{ extra_args | default('') }}
