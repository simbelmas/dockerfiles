---
- name: Create data dir
  file:
    state: directory
    path: "{{ service_user_data.home }}/app_data/{{ container_name }}/{{ item }}"
    owner: "{{ service_user_data.name }}"
    group: "{{ service_user_data.name }}"
    mode: 0700
  with_items:
  -
  - config
  - profiles

- name: Create {{ container_name }} container
  become: yes
  docker_container:
    name: "{{ container_name }}"
    network_mode: host
    state: present
    pull: yes
    image: simbelmas/thunderbird
    env:
      DISPLAY: "unix{{ unix_display.stdout }}"
      UID: "{{ service_user_data.uid }}"
      GID: "{{ service_user_data.group }}"
    volumes:
    - "{{ service_user_data.home }}/app_data/{{ container_name }}/config:/home/svc/.mozilla"
    - "{{ service_user_data.home }}/app_data/{{ container_name }}/profiles:/home/svc/.thunderbird"
    - "{{ service_user_data.home }}/.pulse:/home/svc/.pulse"
    - "/run/user/{{ service_user_data.uid }}/pulse:/run/user/{{ service_user_data.uid }}/pulse"
    - "{{ service_user_data.home }}/.config/gtk-3.0/:/home/svc/.config/gtk-3.0:ro"
    - /etc/localtime:/etc/localtime:ro
    - /tmp/.X11-unix:/tmp/.X11-unix

- name: Create launcher in path
  copy:
    dest: "{{ service_user_data.home }}/bin/{{ container_name }}"
    owner: "{{ service_user_data.name }}"
    mode: 0700
    content: |
      #!/bin/bash -ex
      docker start {{ container_name }} {{ extra_args | default('') }}
